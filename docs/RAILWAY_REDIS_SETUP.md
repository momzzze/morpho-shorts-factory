# Railway Deployment Configuration

## Overview

Your Morpho Shorts Factory is deployed on Railway with the following setup:

- **API** (TypeScript/Express)
- **PostgreSQL** (Database)
- **Redis** (Caching)
- **RabbitMQ** (Messaging - optional)

---

## Railway Setup Guide

### 1. Create Railway Account

1. Go to [railway.app](https://railway.app)
2. Sign up with GitHub
3. Create new project

### 2. Add Services

#### PostgreSQL (Database)

```bash
# Via CLI
railway add --service postgresql

# Or via dashboard: Add ‚Üí Database ‚Üí PostgreSQL
```

Railway auto-generates: `DATABASE_URL`

#### Redis (Caching)

```bash
# Via CLI
railway add --service redis

# Or via dashboard: Add ‚Üí Plugin ‚Üí Redis
```

Railway auto-generates: `REDIS_URL`

#### Deploy API

```bash
# From project root
railway up

# Select: apps/api as root directory
```

### 3. GitHub Actions Integration

Already configured in `.github/workflows/api-ci-cd.yml`:

```yaml
# Auto-deploys on push to main
# Manual deployment for production branch
```

---

## Environment Variables

### Auto-Generated by Railway

```bash
# Database
DATABASE_URL=postgresql://user:password@host:port/dbname

# Redis
REDIS_URL=redis://:password@host:port
```

### Set in Railway Dashboard

1. Go to your project
2. Select service (API)
3. Click "Variables"
4. Add these variables:

```bash
NODE_ENV=production
PORT=3000 (or auto-assigned)
JWT_SECRET=your_32_char_secret_here

# Optional
CORS_ORIGINS=https://yourdomain.com
STORAGE_DRIVER=gcs
GCS_PROJECT_ID=your-project
GCS_BUCKET_NAME=your-bucket
```

---

## Deployment Steps

### Option 1: GitHub Actions (Automatic)

```bash
# Just push to main branch
git add .
git commit -m "feat: add Redis caching"
git push origin main

# GitHub Actions automatically:
# 1. Runs tests against PostgreSQL + Redis
# 2. Builds Docker image
# 3. Pushes to Railway
# 4. Deploys to production
```

### Option 2: Railway CLI (Manual)

```bash
# Login to Railway
railway login

# From project root
railway up

# Follow prompts:
# 1. Select project
# 2. Select service (API)
# 3. Choose source (current directory)
# 4. Wait for deployment
```

### Option 3: Railway Dashboard

1. Open [railway.app/dashboard](https://railway.app/dashboard)
2. Select your project
3. Select API service
4. Click "Deploy" button
5. Wait for green checkmark

---

## Verify Deployment

### Health Check

```bash
curl https://your-api.railway.app/health/live
# Response: {"status":"ok"}
```

### Check Redis Connection

```bash
# Via Railway dashboard logs:
# Should see: "‚úì Redis connected successfully"
```

### Test API Endpoint

```bash
curl https://your-api.railway.app/api/v1/...
```

---

## Monitoring

### Railway Dashboard

1. **Logs Tab:**

   - Real-time API logs
   - Search by request ID
   - Export logs

2. **Metrics Tab:**

   - CPU usage
   - Memory usage
   - Network I/O

3. **Database Tab:**

   - PostgreSQL stats
   - Query monitoring
   - Connections

4. **Redis Tab:**
   - Memory usage
   - Key count
   - Operations/second

---

## Scaling Redis

### Memory Limits

By default, Railway Redis has 256MB limit.

To increase:

1. Go to Redis service in Railway
2. Click "Upgrade" or "Change Plan"
3. Select plan with more memory
4. Redeploy API (no changes needed)

### Monitor Usage

```bash
# View Redis stats in Railway dashboard
# Metrics tab ‚Üí Memory Used
```

---

## Database Migrations

### Deploy Migrations

Migrations run automatically during `pnpm build`:

```json
// package.json
"build": "prisma generate && tsc -p tsconfig.json"
```

### Manual Migration (if needed)

```bash
# Via Railway console
railway run "pnpm --filter api db:migrate:deploy"
```

---

## Environment-Specific Configuration

### Development (GitHub Actions)

```yaml
# .github/workflows/api-ci-cd.yml
services:
  postgres: # Test PostgreSQL
  redis: # Test Redis
  rabbitmq: # Test RabbitMQ
```

### Production (Railway)

```bash
NODE_ENV=production
DATABASE_URL=<auto-set>
REDIS_URL=<auto-set>
JWT_SECRET=<must-set>
```

---

## Troubleshooting

### Deploy Fails

1. Check logs in Railway dashboard
2. Look for error messages
3. Common causes:
   - Missing `JWT_SECRET` variable
   - Port conflicts
   - Database connection timeout

### Redis Not Connecting

```bash
# In Railway logs, should see:
# ‚úì Redis connected successfully

# If not:
# 1. Check REDIS_URL is set
# 2. Verify Redis service is running
# 3. Check firewall rules
```

### Database Connections Limit

```bash
# Check in Railway Postgres metrics
# Default Railway plan: 20 connections

# Increase if needed:
# 1. Upgrade database plan
# 2. Or implement connection pooling
```

### Out of Memory

```bash
# Check Redis memory in metrics
# If > 80% full:
# 1. Increase Redis plan
# 2. Lower TTL values for cached data
# 3. Clear old cache keys
```

---

## Rollback

### Rollback to Previous Deployment

```bash
# Via Railway dashboard:
# 1. Go to Deployments tab
# 2. Click previous successful deployment
# 3. Click "Redeploy"
```

### Rollback Code

```bash
# Via git
git revert <commit-hash>
git push origin main
# GitHub Actions automatically redeploys
```

---

## Security

### Environment Secrets

All secrets stored in Railway are:

- Encrypted at rest
- Not logged
- Only accessible by your team

### Network Security

Railway provides:

- Private database networks
- Auto SSL/TLS
- DDoS protection

---

## Cost Optimization

### Free Tier (Recommended for Dev)

- 5GB storage total
- Shared resources
- Good for testing

### Pro Tier

- Dedicated resources
- Priority support
- Pay per usage

### Estimate Costs

Using [Railway Pricing](https://railway.app/pricing):

| Service    | Free   | Cost/Month        |
| ---------- | ------ | ----------------- |
| PostgreSQL | 5GB    | $0 or pay-per-use |
| Redis      | 256MB  | $0 or $5+         |
| API        | Shared | Included          |

---

## Advanced: Custom Domain

### Add Custom Domain

1. Go to project settings
2. Find "Domain" section
3. Add custom domain (e.g., api.yourdomain.com)
4. Update DNS records at your registrar

### DNS Configuration

```bash
# CNAME record
api.yourdomain.com ‚Üí *.railway.app

# Wait 24 hours for propagation
```

---

## Advanced: Private Network

Connect multiple Railway services privately:

```bash
# 1. Create network in Railway
# 2. Connect API to network
# 3. Connect PostgreSQL to network
# 4. Connect Redis to network

# Services now communicate privately
# No internet exposure
```

---

## Support

- [Railway Documentation](https://docs.railway.app)
- [Railway Support](https://railway.app/support)
- [GitHub Issues](https://github.com/railwayapp/issues)
- [Community Slack](https://railway.app/community)

---

## Next Steps

1. ‚úÖ Deploy API to Railway
2. ‚úÖ Verify all services running
3. ‚úÖ Monitor in dashboard
4. üîê Add custom domain
5. üìä Monitor costs
6. üöÄ Scale as needed
