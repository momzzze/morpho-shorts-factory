generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id             String    @id @default(cuid())
  email          String    @unique
  passwordHash   String
  username       String?   @unique
  displayName    String?
  avatarUrl      String?
  tier           UserTier  @default(FREE)
  storageUsedMb  Int       @default(0)
  storageQuotaMb Int       @default(1000)
  apiKey         String?   @unique
  isActive       Boolean   @default(true)
  emailVerified  Boolean   @default(false)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  lastLoginAt    DateTime?
  tasks          Task[]
  videos         Video[]

  @@index([apiKey])
  @@index([email])
  @@map("users")
}

model Video {
  id               String      @id @default(cuid())
  userId           String
  sourceUrl        String
  sourceSize       BigInt
  originalName     String?
  status           VideoStatus @default(PENDING)
  processingTaskId String?
  outputUrl        String?
  thumbnailUrl     String?
  duration         Int?
  width            Int?
  height           Int?
  codec            String?
  title            String?
  description      String?
  metadata         Json?
  error            String?
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt
  completedAt      DateTime?
  users            User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([status])
  @@index([userId, status])
  @@map("videos")
}

model Task {
  id          String     @id @default(cuid())
  userId      String
  type        String
  status      TaskStatus @default(PENDING)
  payload     Json
  result      Json?
  error       String?
  progress    Int        @default(0)
  createdAt   DateTime   @default(now())
  startedAt   DateTime?
  completedAt DateTime?
  users       User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([status, createdAt])
  @@index([type, status])
  @@index([userId, status])
  @@map("tasks")
}

enum TaskStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum UserTier {
  FREE
  PRO
  ENTERPRISE
}

enum VideoStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}
