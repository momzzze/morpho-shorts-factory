generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id             String    @id @default(cuid())
  email          String    @unique
  passwordHash   String
  username       String?   @unique
  displayName    String?
  avatarUrl      String?
  tier           UserTier  @default(FREE)
  storageUsedMb  Int       @default(0)
  storageQuotaMb Int       @default(1000)
  apiKey         String?   @unique
  isActive       Boolean   @default(true)
  emailVerified  Boolean   @default(false)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  lastLoginAt    DateTime?
  tasks          Task[]
  videos         Video[]

  @@index([apiKey])
  @@index([email])
  @@map("users")
}

model Video {
  id               String      @id @default(cuid())
  userId           String
  
  // Video metadata
  title            String
  description      String?
  niche            String      // e.g., "football", "crafting", "gaming"
  
  // Processing status
  status           VideoStatus @default(PENDING)
  processingTaskId String?
  error            String?
  progress         Int         @default(0)
  
  // Storage paths (GCS or local)
  gcsPath          String?     // e.g., "users/john123/compilations/video-abc.mp4"
  outputUrl        String?     // Full URL when ready
  thumbnailUrl     String?
  
  // Source videos (scraped TikToks)
  sourceVideos     Json?       // Array of {url, title, author, etc.}
  sourceUrl        String?     // Legacy field for single video uploads
  sourceSize       BigInt?
  originalName     String?
  
  // Video properties
  duration         Int?
  width            Int?
  height           Int?
  codec            String?
  metadata         Json?
  
  // Timestamps
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt
  completedAt      DateTime?
  
  users            User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([status])
  @@index([userId, status])
  @@index([niche])
  @@map("videos")
}

model Task {
  id          String     @id @default(cuid())
  userId      String
  type        String
  status      TaskStatus @default(PENDING)
  payload     Json
  result      Json?
  error       String?
  progress    Int        @default(0)
  createdAt   DateTime   @default(now())
  startedAt   DateTime?
  completedAt DateTime?
  users       User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([status, createdAt])
  @@index([type, status])
  @@index([userId, status])
  @@map("tasks")
}

enum TaskStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum UserTier {
  FREE
  PRO
  ENTERPRISE
}

enum VideoStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

// ==============================================================================
// Company & Fundamentals Models (for SEC data & stock screener)
// ==============================================================================

model Company {
  id          String   @id @default(cuid())
  ticker      String   @unique
  cik         String   @unique
  name        String?
  sic         String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  fundamentals FundamentalsSnapshot[]

  @@index([ticker])
  @@index([cik])
  @@map("companies")
}

model FundamentalsSnapshot {
  id           String   @id @default(cuid())
  companyId    String
  company      Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  periodType   String   // "annual" | "ttm" | "quarter"
  periodEnd    DateTime
  currency     String?  // usually USD

  revenue      Float?
  netIncome    Float?
  epsDiluted   Float?
  shares       Float?

  assets       Float?
  liabilities  Float?
  equity       Float?

  cfo          Float?   // cash from operations
  capex        Float?
  fcf          Float?   // computed: cfo - capex

  source       String   // "SEC"
  sourceMeta   Json?    // tags used, form type, etc.

  createdAt    DateTime @default(now())

  @@unique([companyId, periodType, periodEnd])
  @@index([companyId, periodType, periodEnd])
  @@index([periodEnd])
  @@map("fundamentals_snapshots")
}

model JobRun {
  id         String   @id @default(cuid())
  jobType    String   // "SEC_SYNC_COMPANY"
  key        String   // ticker or companyId
  status     String   // "queued" | "running" | "success" | "failed"
  error      String?
  startedAt  DateTime?
  endedAt    DateTime?
  createdAt  DateTime @default(now())

  @@index([jobType, status])
  @@index([key, jobType])
  @@map("job_runs")
}
